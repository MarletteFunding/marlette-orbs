description: >
  This command will use the python versioner and increment and tag the repo

parameters:
  push_gemfury:
    description: Decide whether to push to gemfury or not
    type: boolean
    default: false
steps:
  - restore_cache:
      keys:
        - python-versioner-{{ .Branch }}-{{ .Revision }}
  - run:
      name: Increment version
      command: |
        . venv/bin/activate
        gitlog=$(git log -1 --format=oneline)
        if [[ "$gitlog" ==  *hotfix*  ]]; then increment_revision;
        elif [[ "$gitlog" ==  *major*  ]]; then increment_major;
        else increment_minor; fi
  - run:
      name: Tag and Push source to GitHub
      command: |
        . venv/bin/activate
        git tag $(print_version) $CIRCLE_SHA1
        git push --tags
        git add .
        git -c user.name=CircleCi -c user.email=circleci@marlettefunding.com commit -m "Increment version for next release [skip ci]"
        git push
  - when:
      condition: <<parameters.push_gemfury>>
      steps:
          - run:
              name: Upload distribution to Gemfury
              command: |
                . venv/bin/activate
                python setup.py bdist_wheel
                sh bin/deploy.sh
  - save_cache:
      key: python-sources-{{ .Branch }}-{{ .Revision }}
      paths:
        - .
        - ~/.ssh
