description: >
  This command will setup virtual env

parameters:
  install_requirements:
    description: Decide if requirments are needed
    type: boolean
    default: false

  install_cython:
    description: Decide if cython needs to be installed
    type: boolean
    default: false

  cython_version:
    description: Version of cython to install
    type: string
    default: 0.28.5

  install_requirements_from_setup:
    description: If true use setup.py to install requirements
    type: boolean
    default: false

steps:
  - checkout
  - restore_cache:
      keys:
        - python-orb-{{ .Environment.CIRCLE_PR_REPONAME }}-{{  .Branch }}-{{ checksum "requirements.txt" }}
  - run:
      name: Install and activate virtual environment
      command: |
        if [ ! -d "venv" ]; then
          pip install virtualenv
          virtualenv venv
        fi
  - when:
      condition: <<parameters.install_cython>>
      steps:
        - run:
            name: Install cython
            command: |
              . venv/bin/activate
              pip install cython==<<parameters.cython_version>>

  - when:
      condition: <<parameters.install_requirements>>
      steps:
        - when:
            condition:  <<parameters.install_requirements_from_setup>>
            steps:
              - run:
                  name: Install circle requirements from setup.py
                  command: |
                    . venv/bin/activate
                    pip install -e .[test]

        - unless:
            condition:  <<parameters.install_requirements_from_setup>>
            steps:
              - run:
                  name: Install circle requirements
                  command: |
                    . venv/bin/activate
                    pip install -r requirements.txt
  - save_cache:
      key: python-orb-{{ .Environment.CIRCLE_PR_REPONAME }}-{{  .Branch }}-{{ checksum "requirements.txt" }}
      paths:
        - .
        - ~/.ssh
