description: >
  This job will install python_versioner, increment the version based on last commit message,
  push updated VERSION file back to github, and if applicable push to gemfury.

executor: python
parameters:
  push_gemfury:
    description: Decide whether to push repo to gemfury or not
    type: boolean
    default: false

  from_local:
    description: Decide whether install python versioner from local or gemfury (If true python versioner code must be part of code base)
    type: boolean
    default: false

  wd:
    description: working directory
    type: string
    default: ~/circleci/workspace

  python_versioner_version:
    description: version of python versioner
    type: string
    default: 0.12.0

  project_name:
    description: project name used for finding python wheel
    type: string
    default: DEFAULT PROJECT NAME

  increment_revision:
    description: If true revision number will be incremented
    type: boolean
    default: false

  increment_minor:
    description: If true minor version will be updated
    type: boolean
    default: true

  increment_major:
    description: If true major version will be updated
    type: boolean
    default: false

working_directory: <<parameters.wd>>
steps:
  - setup_venv:
      install_requirements: false
  - restore_cache:
      keys:
        - python-orb-{{ .Environment.CACHE_VERSION }}-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ checksum "requirements.txt" }}
  - when:
      condition: <<parameters.from_local>>
      steps:
        - run:
            name: Install local python versioner
            command: |
              . venv/bin/activate
              pip install -e .
  - unless:
      condition: <<parameters.from_local>>
      steps:
        - run:
            name: Install remote python versioner
            command: |
              . venv/bin/activate
              pip install python-versioner==<<parameters.python_versioner_version>> --extra-index-url https://pypi.fury.io/TAeHp1T6JhyNRkPiK3xt/marlettefunding/

  - when:
      condition: <<parameters.increment_revision>>
      name: increment revision
      run:
        command: |
          . venv/bin/activate
          increment_revision
  - when:
      condition: <<parameters.increment_minor>>
      name: increment minor
      run:
        command: |
          . venv/bin/activate
          increment_minor
  - when:
      condition: <<parameters.increment_major>>
      run:
          command: |
            . venv/bin/activate
            increment_major
  - run:
      name: Tag and Push source to GitHub
      command: |
        . venv/bin/activate
        git tag $(print_version) $CIRCLE_SHA1
        git push --tags
        git add .
        git -c user.name=CircleCi -c user.email=circleci@marlettefunding.com commit -m "Increment version for next release [skip ci]"
        git push
  - when:
      condition: <<parameters.push_gemfury>>
      steps:
        - run:
            name: Upload distribution to Gemfury
            command: |
              . venv/bin/activate
              python setup.py bdist_wheel
              sudo apt-get install curl -y
              cd dist
              wheel_archive=$(find -name "<<parameters.project_name>>-*.whl" -print | head -n 1)
              wheel_archive_name=$(echo $wheel_archive | sed "s/.*\///")

              if [ -n "$wheel_archive_name" ];
              then
                  # Upload new wheel archive to Gemfury
                  curl -F package=@$wheel_archive_name https://TAeHp1T6JhyNRkPiK3xt@push.fury.io/marlettefunding/
              else
                  echo "Wheel archive wasn't found."
              fi
